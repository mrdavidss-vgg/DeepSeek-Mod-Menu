name: Auto Build DeepSeek V1 DLL

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-dll:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    # Step 1: Create minimal C++ DLL source files
    - name: Setup DLL Project
      shell: pwsh
      run: |
        # Create source directory
        New-Item -ItemType Directory -Path src -Force | Out-Null

        # Create main DLL source file
        @'
// Auto-generated DeepSeek V1 DLL
#include <windows.h>

BOOL APIENTRY DllMain(HMODULE hModule, DWORD reason, LPVOID reserved)
{
    return TRUE;
}

// Export your functions here
extern "C" __declspec(dllexport) void DeepSeek_Function() {}
'@ | Out-File -FilePath src/DeepSeekV1.cpp -Encoding ascii

        # Create minimal VS project file
        @'
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <ClCompile Include="src\DeepSeekV1.cpp" />
  </ItemGroup>
  <ItemGroup>
    <Link Include="/DLL /OUT:DeepSeekV1.dll" />
  </ItemGroup>
</Project>
'@ | Out-File -FilePath DeepSeekV1.vcxproj -Encoding ascii

    # Step 2: Set up build environment
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    # Step 3: Build the DLL
    - name: Build DeepSeekV1.dll
      shell: cmd
      run: |
        msbuild DeepSeekV1.vcxproj ^
          /p:Configuration=Release ^
          /p:Platform=x64 ^
          /p:OutDir=.\bin\ ^
          /p:TargetName=DeepSeekV1 ^
          /p:WindowsTargetPlatformVersion=10.0

        if not exist "bin\DeepSeekV1.dll" (
          echo ::error::Failed to build DeepSeekV1.dll
          exit 1
        )

    # Step 4: Package the results
    - name: Upload DLL Artifact
      uses: actions/upload-artifact@v4
      with:
        name: DeepSeekV1-Menu-DLL
        path: bin/DeepSeekV1.dll
        if-no-files-found: error
        retention-days: 7

    # Show build results
    - name: Show Build Output
      shell: pwsh
      run: |
        Get-ChildItem -Path bin/DeepSeekV1.dll
        Write-Output "DLL built successfully!"
