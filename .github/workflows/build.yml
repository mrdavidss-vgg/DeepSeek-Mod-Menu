name: Build DeepSeek V1 DLL

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-dll:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    # Step 1: Create minimal C++ DLL source files
    - name: Setup DLL Project
      shell: cmd
      run: |
        mkdir src
        echo // Auto-generated DeepSeek V1 DLL > src\DeepSeekV1.cpp
        echo #include <windows.h> >> src\DeepSeekV1.cpp
        echo. >> src\DeepSeekV1.cpp
        echo BOOL APIENTRY DllMain(HMODULE hModule, DWORD reason, LPVOID reserved) >> src\DeepSeekV1.cpp
        echo { >> src\DeepSeekV1.cpp
        echo     return TRUE; >> src\DeepSeekV1.cpp
        echo } >> src\DeepSeekV1.cpp
        echo. >> src\DeepSeekV1.cpp
        echo // Export your functions here >> src\DeepSeekV1.cpp
        echo extern "C" __declspec(dllexport) void DeepSeek_Function() {} >> src\DeepSeekV1.cpp

        echo ^<?xml version="1.0" encoding="utf-8"?^> > DeepSeekV1.vcxproj
        echo ^<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003"^> >> DeepSeekV1.vcxproj
        echo ^<ItemGroup^> >> DeepSeekV1.vcxproj
        echo ^<ClCompile Include="src\DeepSeekV1.cpp" /^> >> DeepSeekV1.vcxproj
        echo ^</ItemGroup^> >> DeepSeekV1.vcxproj
        echo ^<ItemGroup^> >> DeepSeekV1.vcxproj
        echo ^<Link Include="/DLL /OUT:DeepSeekV1.dll" /^> >> DeepSeekV1.vcxproj
        echo ^</ItemGroup^> >> DeepSeekV1.vcxproj
        echo ^</Project^> >> DeepSeekV1.vcxproj

    # Step 2: Set up build environment
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    # Step 3: Build the DLL
    - name: Build DeepSeekV1.dll
      shell: cmd
      run: |
        msbuild DeepSeekV1.vcxproj ^
          /p:Configuration=Release ^
          /p:Platform=x64 ^
          /p:OutDir=.\bin\ ^
          /p:TargetName=DeepSeekV1 ^
          /p:WindowsTargetPlatformVersion=10.0
        
        if not exist "bin\DeepSeekV1.dll" (
          echo ::error::Failed to build DeepSeekV1.dll
          exit 1
        )

    # Step 4: Package the results
    - name: Upload DLL Artifact
      uses: actions/upload-artifact@v4
      with:
        name: DeepSeekV1-Menu-DLL
        path: bin\DeepSeekV1.dll
        if-no-files-found: error
        retention-days: 7

    # Show build results
    - name: Show Build Output
      shell: cmd
      run: |
        dir /b bin\DeepSeekV1.dll
